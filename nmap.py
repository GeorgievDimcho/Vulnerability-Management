# metasploitable VM IP 172.28.128.3
# in this script we will run an nmap scan of the VM
import subprocess
import time
# question: nmap nse(nmap scripting engine) uses the CVE database, can it load it locally in case of offline use?
# question: where will the AI scanner/pentester in the network be? in the inside network? bc of firewall 
#IP_ADDR="172.28.128.3" #= target bc /etc/hosts
IP_ADDR='192.168.1.11'
try:
	if subprocess.check_output(["ping", "-c", "1", IP_ADDR]):
		print("The VM is up and running!")
except:
	print("I cannot reach the VM. Check the IP_ADDR and double check if the VM is running.")
file_name = subprocess.check_output(["date"])
file_name = str(file_name).split(' ')
file_name ="reports/"+file_name[1]+"_"+file_name[2]+"_"+file_name[3]+"_"+file_name[len(file_name)-3].replace(":","_")+file_name[len(file_name)-2]
prefix_path="/home/pi/Documents/ai/openai/"
try:
	#if subprocess.check_output(["nmap", "-sT", "-F", "-T5", "-oN", file_name, IP_ADDR]):
	#if subprocess.check_output(["nmap", "-sV", "-p-", "-Pn", "-n", "--version-all", "--open", "-oN", file_name, IP_ADDR]):
	#if subprocess.check_output(["nmap", "--script", "vulners",  "-sV", "-p-", "-Pn", "-n", "--version-all", "--open", "-oN", file_name, IP_ADDR]):
	if subprocess.check_output(["nmap", "--script", "vuln",  "-sV", "-p-", "-Pn", "-n", "--version-all", "--open", "-oN", file_name, IP_ADDR]):
		print("The Nmap scan was successful and the report is saved - " + file_name)
###
	time.sleep(3)
	if subprocess.check_output(["python", prefix_path+"parse.py", file_name]):
		print("The file was parsed") 
	new_file_name=prefix_path+file_name+"_awk"
	cve_file_name=prefix_path+file_name+"_cve.csv"
	if subprocess.check_output(["python", "/home/pi/Documents/app/CVE_Prioritizer-1.4.0/cve_prioritizer.py", "-f", new_file_name, "-o", cve_file_name]):
		print("The CVE_Prioritizer was started successfully")
except Exception as e: 
	print(e)
	print("The Nmap scan encountered an error")
###
